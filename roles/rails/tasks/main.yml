---
- name: Install rails application server packages
  become: yes
  apt:
    state: present
    name:
      - postgresql
      - python-psycopg2
      - redis-server

- name: Create deploy user
  become: yes
  user:
    name: deploy
    comment: Application Deployment
    shell: /bin/bash
    groups: sudo

- name: Copy the SSH public key for the deploy user
  become: yes
  authorized_key:
    user: deploy
    key: "{{ lookup('file', 'roles/dot/files/authorized_keys') }}"

- name: Copy Rails configuration
  become: yes
  copy:
    src: 'config/{{ ansible_hostname }}/rails/'
    dest: /etc/rails
    owner: deploy
    group: deploy
    mode: 0600

- name: Install rbenv for the deploy user
  become: yes
  become_user: deploy
  git:
    repo: https://github.com/rbenv/rbenv.git
    dest: /home/deploy/.rbenv
    version: master

- name: Install rbenv-sudo for the deploy user
  become: yes
  become_user: deploy
  git:
    repo: https://github.com/dcarley/rbenv-sudo.git
    dest: /home/deploy/.rbenv/plugins/rbenv-sudo
    version: master

- name: Install ruby-build for the deploy user
  become: yes
  become_user: deploy
  git:
    repo: https://github.com/rbenv/ruby-build.git
    dest: /home/deploy/.rbenv/plugins/ruby-build
    version: master

- name: Copy the bashrc for the deploy user
  become: yes
  become_user: deploy
  copy: src=bashrc dest=/home/deploy/.bashrc

- name: Copy the profile for the deploy user
  become: yes
  become_user: deploy
  copy: src=profile dest=/home/deploy/.profile

- name: Install Ruby 2.6.1 for the deploy user
  become: yes
  become_user: deploy
  shell: /home/deploy/.rbenv/bin/rbenv install -s 2.6.1
  args:
    creates: /home/deploy/.rbenv/versions/2.6.1

- name: Install Bundler for the deploy user
  become: yes
  become_user: deploy
  shell: RBENV_VERSION=2.6.1 /home/deploy/.rbenv/shims/gem install bundler
  args:
    creates: /home/deploy/.rbenv/versions/2.6.1/bin/bundler

- name: Install Foreman for the deploy user
  become: yes
  become_user: deploy
  shell: RBENV_VERSION=2.6.1 /home/deploy/.rbenv/shims/gem install foreman
  args:
    creates: /home/deploy/.rbenv/versions/2.6.1/bin/foreman

- name: Create /srv/rails
  become: yes
  file:
    path: /srv/rails
    state: directory
    mode: 0755
    owner: deploy
    group: deploy

- name: Create animamagica user in Postgres
  become: yes
  become_user: postgres
  postgresql_user:
    name: animamagica
    password: animamagica
    encrypted: yes

- name: Create animamagica database in Postgres
  become: yes
  become_user: postgres
  postgresql_db:
    name: animamagica
    owner: animamagica
    encoding: UTF-8

- name: Create bln user in Postgres
  become: yes
  become_user: postgres
  postgresql_user:
    name: bln
    password: bln
    encrypted: yes

- name: Create bln database in Postgres
  become: yes
  become_user: postgres
  postgresql_db:
    name: bln
    owner: bln
    encoding: UTF-8

- name: Create cwnmyr user in Postgres
  become: yes
  become_user: postgres
  postgresql_user:
    name: cwnmyr
    password: cwnmyr
    encrypted: yes

- name: Create cwnmyr database in Postgres
  become: yes
  become_user: postgres
  postgresql_db:
    name: cwnmyr
    owner: cwnmyr
    encoding: UTF-8

- name: Create mastodon user in Postgres
  become: yes
  become_user: postgres
  postgresql_user:
    name: mastodon
    password: mastodon
    encrypted: yes

- name: Create mastodon database in Postgres
  become: yes
  become_user: postgres
  postgresql_db:
    name: mastodon
    owner: mastodon
    encoding: UTF-8

- name: Create redmine user in Postgres
  become: yes
  become_user: postgres
  postgresql_user:
    name: redmine
    password: redmine
    encrypted: yes

- name: Create redmine database in Postgres
  become: yes
  become_user: postgres
  postgresql_db:
    name: redmine
    owner: redmine
    encoding: UTF-8
